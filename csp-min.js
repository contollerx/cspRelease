/*! crudeSP 2015-06-12 - Version: 0.9.2
 - License: GPL-3.0 */
var crudeSP=crudeSP||{},csp=crudeSP;crudeSP.user=crudeSP.user||{};var utils=crudeSP.utils||{},commons=crudeSP.commons||{};crudeSP.user.context=SP.ClientContext.get_current(),crudeSP.user.web=crudeSP.user.context.get_web(),crudeSP.user.getName=function(a,b){function c(a,c){b(c.get_message())}function d(){a(e.get_title())}var e="";e=crudeSP.user.web.get_currentUser(),crudeSP.user.context.load(e),crudeSP.user.context.executeQueryAsync(d,c)},crudeSP.user.isMemberOf=function(a,b,c,d){function e(){for(var b=!1,d=i.getEnumerator();d.moveNext();){var e=d.get_current();if(e.get_title()==a){b=!0;break}}c(b)}function f(){d("Failed to get groupmembership of user '"+a+"' . Error:"+args.get_message())}var g=crudeSP.user.web.get_siteGroups(),h=g.getByName(b),i=h.get_users();crudeSP.user.context.load(h),crudeSP.user.context.load(i),crudeSP.user.context.executeQueryAsync(e,f)},crudeSP.returnCaml=function(a,b){new crudeSP.Operation({select:b,where:a,list:"none"});return utils.camlBuilder()},crudeSP.Operation=function(a){function b(a,b,c){this.type="[crudeSP] "+a,this.message=b,console.log(this.type+" - "+this.message)}function c(){if(e.match(r))throw new b("MAIN - invalild token","first list in property 'list' cannot have a table-alias (n. 012)");if(i.list.match("join")&&"number"==typeof i.query)throw new b("MAIN - invalid token","cannot perform a join when query is set to ID (n. 013)")}this.list=a.list,this.site=a.site,this.query=a.where,this.filter=a.filter,this.caml_select=a.select,this.orderBy=a.orderBy,this.debugMode=a.debug||!1,this.take=a.take,this.set=a.set,this.values=a.values,this.customItemPermissions=!0,this.roles=a.roles,this.file=a.file,this.filename=a.filename;var d,e,f,g,h,i=this,j=[],k=[],l=[],m=0,n={},o=[],p=[],q=/[\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00df\w\+#!*\/%\?\-\_]+/,r=new RegExp(q.source+"\\."+q.source),s=new RegExp(q.source+"\\_SEP\\_"+q.source),t=new RegExp(q.source+"\\s+"+q.source),u=/[\'\"\s\(\)\[\]\{\}\=\.]+/,v=new RegExp("\\("+q.source+"\\s+as\\s+"+q.source+"\\)","i");if(i.debugMode&&"undefined"==typeof i.list)throw new b("MAIN - missing parameters","property 'list' not defined (n. 001)");var w=/\s(left[-\s_]?)?join\s/gi;e=i.list.split(w)[0],"undefined"!=typeof i.filter&&"number"==typeof i.query&&(i.query="id = "+i.query),commons.GetListAndItems=function(){var a,b=g.get_lists().getByTitle(e);if("number"==typeof i.query)a=b.getItemById(i.query);else{d=utils.camlBuilder();var c=new SP.CamlQuery;c.set_viewXml(d),a=b.getItems(c)}return{list:b,listItems:a}},commons.iteratorFn=function(a,b){if("undefined"==typeof a.get_count?"function"==typeof a.get_fieldValues&&(m=1):m=a.get_count(),0===m&&console.log("[crudeSP]: MAIN - WARNING: Query returned no results, no rows affected (n. W01)"),m>0)if("function"==typeof a.getEnumerator)for(var c=a.getEnumerator();c.moveNext();){var d=c.get_current();b(d)}else b(a)},commons.replaceCommas=function(a){var b=new RegExp("(\\'"+q.source.substring(0,q.source.length-2)+"\\.\\s,]+\\')");return a.match(b,"g")&&(a=a.replace(b,function(a){return a=a.replace(new RegExp(/,/g),"_COMMA_"),a=a.replace(new RegExp(/\'/g),"")}),commons.replaceCommas(a)),a},commons.stringIsDateFLAWED=function(a){return"number"==typeof a?!1:("object"==typeof a&&(a=String(a)),isNaN(new Date(a))||a.match(/^[a-zA-Z]+\s\d+/)||a.match(/^[\d\s]+$/)?!1:!0)},commons.findFieldErrors=function(a,c,d){var f="";if(2===c?f="UpdateItems":4===c&&(f="CreateItems"),"undefined"==typeof d&&(d=!0),d){if(-1===a.indexOf("="))throw new b(f+": invalid token","no equals operator found in '"+a+"' (n. "+c+"11)");if(a.match(/=/g).length>1)throw new b(f+": invalid token","more then one equals operator found in '"+a+"'. Use ',' to separate columns  (n. "+c+"12)");if(a=a.split("=")[0].trim(),a.match(r))throw new b(f+": invalid token","Table alias found in '"+a+"'. Cannot change columns of non-primary tables: (n. "+c+"14)");if(a.match(u))throw new b(f+": invalid token","illegal character found in '"+a+"' (n. "+c+"13)")}if(-1===l.indexOf(a))throw new b(f+": invalid reference: field '"+a+"' not found in List '"+e+"' - fields are case sensitive (n. "+c+"21)")},commons.checkFieldIsExistent=function(a){if(a.match(r)||a.match(s))return void console.log("[crudeSP]: WARNING: Field '"+a.replace(/_SEP_/,".")+"' cannot be checked for presence in non-primary list (n. W03)");if(!a.match(r)&&!a.match(s)&&-1===l.indexOf(a))throw new b("MAIN - invalid reference","field '"+a+"' does not exist in list '"+e+"'. Fields are case-sensitive. (n. 021)")},commons.checkIfUsersGroupsExist=function(a){function c(){for(var c=0,f=i.roles.length;f>c;c++){var k=i.roles[c].user||i.roles[c].group;if(i.debugMode&&k.match(t))throw new b(h+": invalid token","illegal whitespace found in '"+k+"' use comma to separate user-permissions (n. "+a+"17)");if("undefined"!=typeof i.roles[c].user){for(var l=i.roles[c].user.split(","),m=0,n=l.length;n>m;m++)if(-1===d.indexOf(l[m].replace(g,"").trim()))throw new b(h+"invalid reference","User '"+l[m]+"' not found. "+j+" aborted (n. "+a+"422)")}else if("undefined"!==i.roles[c].group)for(var o=i.roles[c].group.split(","),p=0,q=o.length;q>p;p++)if(-1===e.indexOf(o[p].replace(g,"").trim()))throw new b(h+"invalid reference","User '"+o[p]+"' not found. "+j+" aborted (n. "+a+"422)")}}var d=[],e=[],g=new RegExp(q.source+"[(\\\\)|(\\/)]+"),h="",j="";if(4===a?(h="CreateItems",j="Insert"):2===a&&(h="UpdateItems",j="Update"),"undefined"==typeof i.roles.length){var k=i.roles;i.roles=[],i.roles.push(k)}utils.restRequest(f+"/_api/web/sitegroups?$select=title","title").then(function(a){e=a,utils.restRequest(f+"/_api/web/siteusers","loginname").then(function(a){d=a,c()})})},utils.handleInlineExp=function(a,b){if((0==a||"builder"===b)&&(p=o.length>0?o:i.caml_select.split(",")),p[a].match(v)){var c=v.exec(p[a])[0];p.splice(a,1);var d=c.replace(/\(|\)/g,"").split(/\s+as\s+/i);isNaN(d[0])?commons.stringIsDateFLAWED(d[0])&&(d[0]=new Date(d[0]).toISOString()):d[0]=parseInt(d[0]),n[d[1].trim()]=d[0]}},utils.encodeNames=function(a){for(var b=a.split(""),c="",d=0;d<b.length;d++){var e=escape(b[d]);e.length>1&&(e=e.toLowerCase()),c+=3==e.length?e.replace("%","_x00")+"_":5==e.length?e.replace("%u","_x")+"_":e}return c},utils.restRequest=function(a,b){var c=new $.Deferred,d=[],e=new XMLHttpRequest;return e.open("GET",a,!0),e.setRequestHeader("Accept","application/json; odata=verbose"),e.onreadystatechange=function(){if(4===e.readyState){for(var a=JSON.parse(e.responseText),f=0,g=a.d.results.length;g>f;f++)"title"===b?d.push(a.d.results[f].Title):"loginname"===b&&d.push(a.d.results[f].LoginName.replace(/[\w\:\.\|\#]+\\/,""));c.resolve(d)}},e.send(null),c.promise()},utils.getContextWeb=function(){function a(a){d.resolve(a)}var d=new $.Deferred;if(i.debugMode&&(c(),"undefined"==typeof SP))throw new b("missing prerequisites","Sharepoint client-side libraries not loaded properly (n. 091)");return"undefined"==typeof i.site?(h=SP.ClientContext.get_current(),f=window.location.href.substring(0,window.location.href.indexOf("SitePages/Home.aspx"))):(h=new SP.ClientContext(i.site),f=i.site),g=h.get_web(),i.debugMode?utils.restRequest(f+"/_api/web/lists/getByTitle('"+e+"')/fields","title").then(a):a(),d.promise()},utils.deleteRoles=function(a){var b=new $.Deferred,c=a.get_roleAssignments();return a.breakRoleInheritance(!0),h.load(c),h.executeQueryAsync(function(){for(var a=[],d=c.getEnumerator();d.moveNext();)a.push(d.get_current());for(var e=0,f=a.length;f>e;e++)a[e].deleteObject();h.executeQueryAsync(function(){b.resolve()},function(a,b){console.log(b.get_message())})},function(a,b){console.log(b.get_message())}),b.promise()},utils.assignRoles=function(a,c){function d(a,b){console.log(b.get_message())}var e=h.get_web(),f=["read","write","contribute"],g=[SP.RoleType.reader,SP.RoleType.editor,SP.RoleType.contributor],j=[];"undefined"==typeof i.roles.length?j.push(i.roles):j=i.roles;for(var k=0,l=j.length;l>k;k++){if(i.debugMode){if(-1===f.indexOf(j[k].type))throw new b("AssignRoles: invalid token","role '"+j[k]+"'not valid. (use read, write, contribute) (n. 511)");if("undefined"!=typeof j[k].user&&"undefined"!=typeof j[k].group)throw new b("AssignRoles: invalid token","cannot have 'user' and 'group' in the same instance (n. 512)");if("undefined"!=typeof j[k].user){if(j[k].user.match(t))throw new b("AssignRoles: invalid token","Users not separated with comma at "+j[k].user+" (n. 513)")}else if("undefined"!=typeof j[k].group&&j[k].group.match(t))throw new b("AssignRoles: invalid token","Groups not separated with comma at "+j[k].group+" (n. 513)")}var m,n,o,p;"undefined"!=typeof j[k].user?(m=j[k].user.split(","),p=m.length):(n=j[k].group.split(","),p=n.length);for(var q=0;p>q;q++){if("undefined"!=typeof m){for(var r,s=[/\n/,/\r/,/\t/,/\f/],u=["n","r","t","f"],v=0;6>v;v++)if(m[q].match(s[v])){r=m[q].replace(s[v],"\\"+u[v]);break}r=r.replace(/[\/]+/,"\\"),o=e.ensureUser(r)}else o=e.get_siteGroups().getByName(n[q].trim());for(var w=SP.RoleDefinitionBindingCollection.newObject(h),x=0;3>x;x++)if(j[k].type===f[x]){w.add(e.get_roleDefinitions().getByType(g[x]));for(var y=0,z=a.length;z>y;y++){var A=a[y];A.breakRoleInheritance(!1),A.get_roleAssignments().add(o,w)}break}}}h.executeQueryAsync(function(){c()},d)},utils.camlBuilder=function(){function a(a,c){if(i.debugMode)if(1===c){if(a.match(/[\.]{2}/g)||a.match(/[\_]{2}/g))throw new b("invalid token","too much '.' or '_' found in: "+a+" (n. 915)")}else if(c>1&&a.match(u)){if(2===c)throw new b("invalid token","illegal character found in alias: "+a+" (n. 9112)");if(3===c&&a.match(r))throw new b("invalid token","illegal character found in field: "+a+" (n. 9113)")}}function b(a,b){this.type="[crudeSP] CAML-BUILDER - "+a,this.message=b,console.log(this.type+" - "+this.message)}function c(){if(m="<View>","undefined"!=typeof i.take&&(m+="<RowLimit Paged='False'>"+i.take+"</RowLimit>"),"undefined"!=typeof i.filter){var a=i.filter.readOperationName||"ReadList";m+="<Method Name='"+a+"'>"}"undefined"!=typeof i.filter&&(m+="<Filter Name='"+i.filter.name+"' Value='"+i.filter.value+"' />"),"undefined"!=typeof i.filter&&(m+="</Method>"),m+="<Query>","undefined"!=typeof i.query&&(m+="<Where>")}function d(a){var b=[];!function c(a){var d=(a.match(/\s+and\s+|^and\s+/g)||[]).length,e=(a.match(/\s+or\s+/g)||[]).length,f=(a.match(/\(/g)||[]).length,g=(a.match(/\)/g)||[]).length;if(0==d&&0==e&&0==f&&0==g)return void b.push(a);var h=[];!function(){for(var b=0;4>b;b++){var c;0===b?c=" and ":1===b?c=" or ":2===b?c="(":3===b&&(c=")");var d=1e4;-1!==a.indexOf(c)&&(d=a.indexOf(c)),h[b]={index:d,sliceby:c,slicebyLen:c.length}}h.sort(function(a,b){return a.index-b.index})}();var i=a.substr(0,a.indexOf(h[0].sliceby)).trim();""!==i&&b.push(i),b.push(h[0].sliceby.trim()),c(a.substr(a.indexOf(h[0].sliceby)+h[0].slicebyLen).trim())}(a),e(b)}function e(c){function d(a){for(var c=!1,d=0,e=n.straightOperands.length;e>d;d++)-1!==a.indexOf(n.straightOperands[d])&&(c=!0);if(!c)throw new b("invalid token","no comparing operand in: "+a+" (n. 914)")}function e(a){for(var b={},c=0,d=n.straightOperands.length;d>c;c++)a.match(n.straightOperandsRgx[c])&&(b.camlOps=n.camlOperands[c],b.normalOps=n.straightOperands[c],b.camlOpsClosed=n.camlOperandsClosed[c]);return b}function f(a){var b={};return b.value=a,isNaN(a)?commons.stringIsDateFLAWED(a)?(b.typ="DateTime",b.value=new Date(a).toISOString()):b.typ="Text":a%1==0?b.typ="Integer":b.typ="Number",b}for(var g=[],h=0,j=c.length;j>h;h++)if("and"!==c[h]&&"or"!==c[h]&&"("!==c[h]&&")"!==c[h]&&""!==c[h].trim()){var k=c[h],m=e(k),o=k.split(m.normalOps)[0].trim().split(".");if(i.debugMode){if(k.match(/\'/)&&k.match(/\'/g).length%2!==0)throw new b("invalid token","no closing ' found at "+k+" (n. 9115)");d(k);var q=k.split(m.normalOps)[0].trim();a(q,1),commons.checkFieldIsExistent(q)}k=k.replace(new RegExp(/\'/g),"");var r="";2===o.length?(y.push(o[0]),r=o[0]+"_SEP_"+o[1]):r=o.join("");var s=k.split(m.normalOps)[1].trim();if(-1===p.indexOf(r)&&p.push(r),"IN"===m.normalOps){i.debugMode&&!function(){if(s.match(/\d+\s+\d+/))throw new b("invalid token","IN: numbers not separated by commas (n. 913)")}(),g.push(m.camlOps),g.push("<FieldRef Name = '"+r+"' />"),g.push("<Values>");for(var t=s.split(","),u=0,v=t.length;v>u;u++){var w=f(t[u].trim()),x="<Value Type='"+w.typ+"'>";g.push(x+t[u].trim()+"</Value>")}g.push("</Values>"),g.push(m.camlOpsClosed)}else{g.push(m.camlOps),g.push("<FieldRef Name = '"+utils.encodeNames(r)+"' />");var z=f(s);g.push("<Value Type='"+z.typ+"'>"+z.value+"</Value>"),g.push(m.camlOpsClosed)}}else"and"===c[h]||"or"===c[h]?g.push(e(c[h]).camlOps):("("===c[h]||")"===c[h])&&g.push(c[h]);l(g)}function f(){var a="";if("undefined"!=typeof i.orderBy){a="<OrderBy>";for(var c=i.orderBy.split(","),d=0,e=c.length;e>d;d++){var f=c[d].trim();i.debugMode&&!function(){var a=c[d].replace(/\s+asc|\s+desc/gi,"");if(a.match(t))throw new b("invalid token","orderBy fields need to be divided by comma (n. 9111)")}();var g=f.split(/\s+/)[0].replace(/\./g,"_SEP_");g.match(/_SEP_/)&&z.push(g.split("_SEP_")[0]);var h="TRUE";f.match(/\s+desc/i)&&(h="FALSE"),w.push(g),a+="<FieldRef Name='"+utils.encodeNames(g)+"' Ascending='"+h+"' />"}a+="</OrderBy>"}return a+="</Query>"}function g(){var c="",d="";return"undefined"!=typeof i.list&&i.list.match(/\s+(left[-\s_]?)?join\s+/gi)&&(c=function(){var c="<Joins>";i.list=i.list.replace(/\s+join\s+/gi," join "),i.list=i.list.replace(/\s+left[-\s+_]?join\s+/gi," left-join "),i.list=i.list.replace(/\s+with\s+/gi," with ");for(var d=i.list.split(","),e="",f=0,g=d.length;g>f;f++){var h=/join/,j="INNER";d[f].match(/left[-\s_]?join/i)&&(h=/left[-\s_]?join/i,j="LEFT");var k=d[f].split(h)[0].trim(),l=d[f].split(h)[1].trim(),m=l.split("with"),n=m[0].trim();i.debugMode&&(!function(){if(i.list.match(/right[-\s+_]?join/gi))throw new b("not supported","right join is not supported by the system (n. 931)");if(d[f].match(/left[-\s+_]?join[\w\s]+?((left[-\s+_]?)?join)/i))throw new b("invalid token","join-operations need to be devided with a comma (n. 917)")}(),a(n,2)),x.push(n);var o=m[1].trim().replace(/.*\./,"");0===f&&(e=k);var p="";k!==e&&""!==k&&(p="List='"+k+"'"),c+="<Join Type='"+j+"' ListAlias='"+n+"' >",c+="<Eq>",c+="<FieldRef "+p+" Name='"+utils.encodeNames(o)+"' RefType='Id' />",c+="<FieldRef List='"+n+"' Name='ID' />",c+="</Eq>",c+="</Join>"}return c+="</Joins>"}(),d=function(){o="undefined"!=typeof i.caml_select?i.caml_select.split(","):p;for(var a="<ProjectedFields>",b=0,c=x.length;c>b;b++)for(var d=0,e=o.length;e>d;d++)if(-1!==o[d].indexOf(".")||-1!==o[d].indexOf("_SEP_")){var f=".";-1!==o[d].indexOf("_SEP_")&&(f="_SEP_");var g=o[d].split(f)[0].trim(),h=o[d].split(f)[1].trim().replace(/\s+as\s+/gi," as ");if(h.match(/\s+as\s+[^.]*/i)&&(h=h.split(/\s+as\s+/i)[0]),g===x[b]){a+="<Field ShowField='"+utils.encodeNames(h)+"' Type='Lookup' Name='"+g+"_SEP_"+utils.encodeNames(h)+"' List='"+g+"' />";var j="";o[d].match(/\s+as\s+[^.]*/i)&&(j=" as "+o[d].split(/\s+as\s+/i)[1]),o.splice(d,1,g+"_SEP_"+h+j)}}return a+="</ProjectedFields>"}()),c+d}function h(){function c(c){for(var e=0,f=c.length;f>e;e++)c[e]=c[e],(c[e].match(r)||c[e].match(s))&&A.push(c[e].split(/\.|\_SEP\_/)[0]),i.debugMode&&!function(){for(var a=0,c=x.length;c>a;a++)if(x[a].match(u))throw new b("invalid token","illegal character found in alias: "+x[a]+"  (n. 9112)");for(var d=0,e=z.length;e>d;d++)if(-1===x.indexOf(z[d]))throw new b("invalid reference","alias: "+z[d]+" in orderBy not found in list (n. 921)");for(var f=0,g=y.length;g>f;f++)if(-1===x.indexOf(y[f]))throw new b("invalid reference","alias: "+y[f]+" in where not found in list (n. 922)");for(var h=0,i=A.length;i>h;h++)if(-1===x.indexOf(A[h]))throw new b("invalid reference","alias: "+A[h]+" in select not found in list (n. 924)")}(),a(c[e],3),j.push(c[e]),d+="<FieldRef Name ='"+utils.encodeNames(c[e])+"' />"}var d="<ViewFields>";if("undefined"==typeof i.caml_select)k=p.slice(0),c(p);else{var e=[];0===o.length&&(o=i.caml_select.split(","));for(var f=0,g=o.length;g>f;f++){var h=o[f].trim();if(o[f].match(v))utils.handleInlineExp(f,"builder");else if(h=h.replace(/\s+as\s+/gi," as "),i.debugMode&&!function(){var a=o[f].replace(new RegExp("\\s+as\\s+"+q.source,"gi"),"").trim();if(o[f].match(/\(/g)||o[f].match(/\)/g)){if(!o[f].match(/\(/g)||!o[f].match(/\)/g))throw new b("invalid token","discrepancy between opening and closing brackets found at '"+o[f].trim()+"' (n. 9116)");if(o[f].match(/\(/g).length!==o[f].match(/\)/g).length)throw new b("invalid token","discrepancy between opening and closing brackets found at '"+o[f].trim()+"' (n. 9116)");if(!o[f].match(new RegExp(q.source+"\\s+as\\s+","i")))throw new b("invalid token","no 'as' found in inline expression '"+o[f].trim()+"' (n. 9117)")}if(commons.checkFieldIsExistent(a),a.match(t))throw new b("invalid token","select fields need to be divided by comma (n. 918)");if(o[f].match(/^\s+?as/gi))throw new b("invalid token","fieldname cannot be 'as' (n. 919)");if(i.list.match(/\s(left[-\s+_]?)?join\s+/gi)&&i.caml_select.match(/_SEP_/g))throw new b("invalid token","field: '"+o[f]+"' cannot be contain '_SEP_' when using join (n. 9110)")}(),h.match(/\sas\s[^.]*/)){var l=h.split(/\s+as\s+/i);k.push(l[1].trim()),e.push(l[0].trim())}else k.push(h),e.push(h)}c(e)}return i.debugMode&&!function(){for(var a=0,c=w.length;c>a;a++)if(-1===j.indexOf(w[a]))throw new b("invalid reference","orderBy: field '"+w[a].replace(/_SEP_/,".")+"' not found in selected fields (n. 923)")}(),d+="</ViewFields>"}function l(a){var b,c=[],d=[],e=0,j=0;!function k(f){for(var g=!1,h=f,i=a.length;i>h;h++){var l=0;if(0!==e&&(l=e+1),"<And>"===a[h]||"<Or>"===a[h]){g=!0,e=h,b=a[h],c.push(n.camlOperandsClosed[n.camlOperands.indexOf(a[h])]),a.splice(h,1),a.splice(l,0,b);break}if("("===a[h]){j=h;for(var m=h+1;i>m;m++){if("<And>"===a[m]||"<Or>"===a[m]){d.push(n.camlOperandsClosed[n.camlOperands.indexOf(a[m])]),a.splice(h,1,a[m]),a.splice(m,1),e=m-1,g=!0;break}if(")"===a[m]){a.splice(h,1),a.splice(m-1,1);break}}break}if(")"===a[h]){if(a.splice(h,1,d[d.length-1]),d.splice(-1,1),"<And>"===a[h+1]||"<Or>"===a[h+1])c.push(n.camlOperandsClosed[n.camlOperands.indexOf(a[h+1])]),a.splice(j,0,a[h+1]),a.splice(h+2,1),e=h,g=!0;else if(")"===a[h+1]){g=!0,e=h;break}break}}g&&k(e)}(0),function(){for(var b=c.length;b>=0;b--)a.push(c[b]);"undefined"!=typeof i.query&&a.push("</Where>")}(),m+=a.join(""),m+=f(),m+=g(),m+=h(),m+="</View>"}i.debugMode&&!function(){if("undefined"==typeof i.caml_select&&"undefined"==typeof i.query)throw new b("missing parameters","no query entered (n. 901)");if("undefined"!=typeof i.query&&(i.query.match(/\(/g)||i.query.match(/\)/g))){if(!i.query.match(/\(/g)||!i.query.match(/\)/g))throw new b("invalid token","discrepancy between opening and closing brackets (n. 911)");if(i.query.match(/\(/g).length!==i.query.match(/\)/g).length)throw new b("invalid token","discrepancy between opening and closing brackets (n. 911)");for(var a=i.query.split("("),c=1,d=a.length;d>c;c++)if(-1===a[c].indexOf("and")&&-1===a[c].indexOf("or"))throw new b("invalid token","logical operand missing at: "+a[c]+" (n. 912)")}if("undefined"!=typeof i.take&&(i.take%1!==0||i.take<0))throw new b("invalid token","Value for take must be a positive integer (n. 913)")}();var m="",n={straightOperands:["<>","=","!=","<","<=",">",">=","IS NULL","IS NOT NULL","CONTAINS","BEGINS WITH","IN","and","or"],straightOperandsRgx:[/<>/,/=/,/!=/,/</,/<=/,/>/,/>=/,/IS\s+NULL/,/IS\s+NOT\s+NULL/,/\s+CONTAINS\s+/,/BEGINS\s+WITH/,/\s+IN\s+/,/(\s+and\s+)|(^and[\s+]?$)/,/(\s+or\s+)|(^or[\s+]?$)/],camlOperands:["<Neq>","<Eq>","<Neq>","<Lt>","<Leq>","<Gt>","<Geq>","<IsNull>","<IsNotNull>","<Contains>","<BeginsWith>","<In>","<And>","<Or>"],camlOperandsClosed:["</Neq>","</Eq>","</Neq>","</Lt>","</Leq>","</Gt>","</Geq>","</IsNull>","</IsNotNull>","</Contains>","</BeginsWith>","</In>","</And>","</Or>"]},p=[],w=[],x=[],y=[],z=[],A=[];return function(){c(),"undefined"!=typeof i.query?(i.query=i.query.replace(/\s+and\s+/gi," and "),i.query=i.query.replace(/\s+or\s+/gi," or "),i.query=i.query.replace(/is\snull/gi,"IS NULL"),i.query=i.query.replace(/is\snot\snull/gi,"IS NOT NULL"),i.query=i.query.replace(/\s+contains\s+/gi," CONTAINS "),i.query=i.query.replace(/begins\swith/gi,"BEGINS WITH"),i.query=i.query.replace(/\s+in\s+/gi," IN "),d(i.query)):d("")}(),m},this.readItems=function(a,c){function d(){function b(a){var b,e={},f=[];if(0===j.length){o=i.caml_select.split(",");for(var g=0,h=o.length;h>g;g++)utils.handleInlineExp(g);j=o}for(var l=0,m=j.length;m>l;l++)j[l]=j[l].trim(),j[l].match(/\s+as\s+[^.]*/i)?(k.push(j[l].split(/\s+as\s+/i)[1]),j[l]=j[l].split(/\s+as\s+/i)[0]):k.push(j[l]),j[l]=utils.encodeNames(j[l]),b=k[l].replace(new RegExp(q.source+"\\_SEP\\_"),""),i.debugMode&&!c&&(-1!==f.indexOf(b)?d=b:f.push(b),0!==d.length&&(c=!0,console.log("[crudeSP]: ReadItems - WARNING: Fieldname '"+d+"' occurs in more than one list, please specify an alias to distinguish the fields (n. W02)"))),j[l].match(new RegExp(q.source+"\\."))&&(j[l]=j[l].replace(new RegExp("^("+q.source+"?)\\."),function(a){return a[0]+"_SEP_"})),null!==a.get_item(j[l])?"SP.FieldLookupValue"===a.get_item(j[l]).constructor.getName()?e[b]=a.get_item(j[l]).get_lookupValue():e[b]=a.get_item(j[l]):e[b]="";if(!$.isEmptyObject(n))for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r]);p.push(e)}if(i.debugMode)var c=!1,d="";commons.iteratorFn(m,b),a(p)}function e(a,b){"undefined"!=typeof c&&c(b.get_message())}var f,g,m,p=[];if(i.debugMode&&"undefined"==typeof a)throw new b("ReadItems: missing parameters","no callback function given (n. 101)");utils.getContextWeb().then(function(a){l=a,f=new commons.GetListAndItems,g=f.list,m=f.listItems,h.load(g),h.load(m),h.executeQueryAsync(d,e)})},this.updateItems=function(a,c){function d(){function a(a){if(m>0){if(o.push(a),i.debugMode&&"undefined"==typeof i.set&&"undefined"==typeof i.roles)throw new b("UpdateItems: missing parameters","no set or roles operation defined in update (n. 201)");if("undefined"!=typeof i.set)if("string"==typeof i.set){i.set=commons.replaceCommas(i.set);for(var c=i.set.split(","),d=0,e=c.length;e>d;d++){i.debugMode&&commons.findFieldErrors(c[d],2);var f=c[d].split("=")[0].trim(),g=c[d].split("=")[1].trim();f=utils.encodeNames(f),g=g.replace(/\_COMMA\_/,","),commons.stringIsDateFLAWED(g)&&(g=new Date(g).toISOString()),a.set_item(utils.encodeNames(f),g)}a.update()}else if("object"==typeof i.set){if(i.debugMode&&"undefined"!=typeof i.set.length)throw new b("UpdateItems: invalid token","set cannot be an array (n. 215)");for(var h in i.set)if(i.set.hasOwnProperty(h)){var j=utils.encodeNames(h),k=i.set[h];i.debugMode&&commons.findFieldErrors(h,2,!1),a.set_item(utils.encodeNames(j),k)}a.update()}else if(i.debugMode)throw new b("UpdateItems: invalid token","values must be of type string or object (n. 216)")}}commons.iteratorFn(n,a),h.executeQueryAsync(f,e)}function e(a,b){"undefined"!=typeof c&&c(b.get_message())}function f(){function a(a){for(var b=new $.Deferred,c=[],d=0,e=a.length;e>d;d++)c.push(a[d]);return function f(){0!==c.length?utils.deleteRoles(c[0]).then(function(){c.splice(0,1),f()}):b.resolve()}(),b.promise()}if(m>0)if("undefined"!=typeof i.roles){var b=i.roles[0]||i.roles;b.deleteExisting?a(o).then(function(){p||utils.assignRoles(o,g)}):utils.assignRoles(o,g)}else g()}function g(){"undefined"!=typeof a&&a()}var j,k,n,o=[],p=!1;utils.getContextWeb().then(function(a){function b(){h.load(n),h.executeQueryAsync(d,e)}l=a,j=new commons.GetListAndItems,k=j.list,n=j.listItems,"undefined"!=typeof i.roles?(commons.checkIfUsersGroupsExist(2),b()):b()})},this.deleteItems=function(a,b){function c(){function a(a){m>0&&j.push(a)}if(commons.iteratorFn(i,a),m>0){for(var b=0,c=j.length;c>b;b++)j[b].deleteObject();h.executeQueryAsync(e,d)}else e()}function d(a,c){"undefined"!=typeof b&&b(c.get_message())}function e(){"undefined"!=typeof a&&a()}var f,g,i,j=[];utils.getContextWeb().then(function(a){l=a,f=new commons.GetListAndItems,g=f.list,i=f.listItems,j=[],h.load(i),h.executeQueryAsync(c,d)})},this.createItems=function(a,c){function d(){if(i.debugMode&&"undefined"==typeof i.values)throw new b("CreateItems: missing parameters","no values entered (n. 401)");var a;if("string"==typeof i.values)for(var c=i.values.split(/\)\s+?\,\s+?\(/),d=0,e=c.length;e>d;d++){var g=new SP.ListItemCreationInformation;if(a=k.addItem(g),m.push(a),c[d]=c[d].replace(/[\(\)]/g,""),i.debugMode&&c[d].match(/[\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00df\w\+#!*\/%\?\-\_\s]+,[\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00df\w\+#!*\/%\?\-\_\s]+,/))throw new b("CreateItems: invalid token","unexpected comma in '"+c[d]+"' (n. 415)");c[d]=commons.replaceCommas(c[d]);for(var l=c[d].split(","),n=0,o=l.length;o>n;n++){l[n]=l[n].replace(/\\,/,","),i.debugMode&&commons.findFieldErrors(l[n],4);var p=l[n].split("=")[0].trim(),q=l[n].split("=")[1].trim().replace(new RegExp(/\_COMMA\_/g),",");a.set_item(utils.encodeNames(p),q)}a.update(),h.load(a)}else if("object"==typeof i.values){var r=[];"undefined"==typeof i.values.length?r.push(i.values):r=i.values;for(var s in r){var t=new SP.ListItemCreationInformation;a=k.addItem(t),m.push(a);for(var u in r[s])if(r[s].hasOwnProperty(u)){i.debugMode&&commons.findFieldErrors(u,4,!1);var v=utils.encodeNames(u),w=r[s][u];commons.stringIsDateFLAWED(w)&&(w=new Date(w).toISOString()),a.set_item(utils.encodeNames(v),w)}a.update(),h.load(a)}}else if(i.debugMode)throw new b("CreateItems: invalid token","values must be of type string or array (n. 416)");h.executeQueryAsync(j,f)}function f(a,b){"undefined"!=typeof c&&c(b.get_message())}function j(){"undefined"!=typeof a&&a(),"undefined"!=typeof i.roles&&utils.assignRoles(m,a)}var k,m=[];utils.getContextWeb().then(function(a){l=a,k=g.get_lists().getByTitle(e),"undefined"!=typeof i.roles?(commons.checkIfUsersGroupsExist(4),d()):d()})},this.uploadToLibrary=function(a,c){function d(a){var b=$.Deferred(),c=new FileReader;return c.onload=function(a){b.resolve(a.target.result)},c.onerror=function(a){b.reject(a.target.error)},c.readAsArrayBuffer(a),b.promise()}if(i.debugMode&&"undefined"==typeof i.file)throw new b("Upload to library: missing parameters","no file provided (n. 501)");"undefined"==typeof i.site&&(i.site=window.location.href.substring(0,window.location.href.indexOf("SitePages/Home.aspx"))),d(i.file).then(function(){"undefined"==typeof i.filename&&(i.filename=i.file.name);var b=i.site+"/_api/web/GetFolderByServerRelativeUrl('"+i.list+"')/Files/Add(url='"+i.filename+"', overwrite=true)?$expand=ListItemAllFields",d=new XMLHttpRequest;d.open("POST",b,!0),d.setRequestHeader("Accept","application/json; odata=verbose"),d.setRequestHeader("X-RequestDigest",$("#__REQUESTDIGEST").val()),d.processData=!1;var e=!1;d.onreadystatechange=function(b){if(4===d.readyState&&!e)if(e=!0,"undefined"!=typeof i.set){var f=JSON.parse(b.currentTarget.response).d.ListItemAllFields.Id,g=new csp.Operation({set:i.set,list:i.list,where:f});"undefined"!=typeof i.roles&&(g.roles=i.roles),"undefined"!=typeof i.list&&(g.site=i.site),g.updateItems(a,c)}else a(b)},d.onerror=function(a){c(a)},d.send(null)})}};